<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers">

<f:layout name="Default" />

<f:section name="Content">
    <div class="flipbook-container" style="max-width: 100%; margin: 20px auto; font-family: Arial, sans-serif;">
        
        <f:if condition="{document}">
            <f:then>
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">{document.title}</h2>
                    <f:if condition="{document.description}">
                        <div style="margin-top: 10px; color: #666;">
                            <f:format.html>{document.description}</f:format.html>
                        </div>
                    </f:if>
                    <div style="margin-top: 10px; font-size: 14px; color: #999;">
                        Total Pages: {images -> f:count()} | Status: Processed | Document UID: {document.uid}
                    </div>
                    
                    <!-- QUICK DEBUG -->
                    <div style="background: #ffffcc; padding: 10px; margin: 10px 0; font-size: 12px; border: 1px solid #ffcc00;">
                        <strong>üîç Quick Check:</strong> 
                        Document "{document.title}" (UID: {document.uid}) | 
                        Images: {images -> f:count()} | 
                        <f:if condition="{images.0.isTestImage}">
                            <f:then>
                                <span style="color: red;">Using TEST images</span>
                            </f:then>
                            <f:else>
                                <span style="color: green;">Using REAL images</span>
                            </f:else>
                        </f:if>
                    </div>
                </div>

                <!-- Main Flipbook Area -->
                <div class="flipbook-main" style="position: relative; max-width: 1200px; margin: 0 auto; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    
                    <!-- Book Pages Container with 3D perspective -->
                    <div class="book-container" style="perspective: 1200px; width: 100%; height: 600px; background: linear-gradient(45deg, #f0f0f0, #e8e8e8); position: relative; overflow: hidden;">
                        
                        <!-- Book spine/binding -->
                        <div class="book-spine" style="position: absolute; left: 50%; top: 0; width: 4px; height: 100%; background: linear-gradient(to bottom, #8B4513, #A0522D); transform: translateX(-50%); z-index: 100; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>
                        
                        <!-- Left Page -->
                        <div class="page-left" style="position: absolute; left: 0; top: 0; width: 50%; height: 100%; background: white; box-shadow: inset -5px 0 15px rgba(0,0,0,0.1); overflow: hidden;">
                            <f:for each="{images}" as="image" iteration="iterator">
                                <div class="book-page left-page" data-page="{image.page}" 
                                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; padding: 20px; box-sizing: border-box; background: white;">
                                    <img src="{image.publicUrl}" alt="Page {image.page}" 
                                         style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;" />
                                    <div style="position: absolute; bottom: 10px; left: 20px; font-size: 12px; color: #666; background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 3px;">
                                        {image.page}
                                    </div>
                                </div>
                            </f:for>
                        </div>
                        
                        <!-- Right Page -->
                        <div class="page-right" style="position: absolute; right: 0; top: 0; width: 50%; height: 100%; background: white; box-shadow: inset 5px 0 15px rgba(0,0,0,0.1); overflow: hidden;">
                            <f:for each="{images}" as="image" iteration="iterator">
                                <div class="book-page right-page" data-page="{image.page}" 
                                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; padding: 20px; box-sizing: border-box; background: white;">
                                    <img src="{image.publicUrl}" alt="Page {image.page}" 
                                         style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;" />
                                    <div style="position: absolute; bottom: 10px; right: 20px; font-size: 12px; color: #666; background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 3px;">
                                        {image.page}
                                    </div>
                                </div>
                            </f:for>
                        </div>
                        
                        <!-- Page Turn Effect Overlay -->
                        <div class="page-turn-effect" style="position: absolute; top: 0; left: 50%; width: 50%; height: 100%; background: linear-gradient(to right, transparent, rgba(0,0,0,0.1), transparent); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; z-index: 50;"></div>
                    </div>

                    <!-- Control Panel -->
                    <div class="control-panel" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 15px 20px; border-radius: 25px; color: white; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        
                        <!-- Navigation -->
                        <button onclick="goToPrevPage()" class="nav-btn" 
                                style="background: #007cba; border: none; color: white; padding: 10px 15px; border-radius: 50%; cursor: pointer; font-size: 16px; transition: all 0.2s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;"
                                onmouseover="this.style.background='#005a8a'; this.style.transform='scale(1.1)'" 
                                onmouseout="this.style.background='#007cba'; this.style.transform='scale(1)'">
                            ‚óÄ
                        </button>
                        
                        <!-- Page Display -->
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 15px; font-weight: bold; min-width: 80px; text-align: center;">
                            <span id="current-page-display">1</span> / <span id="total-pages-display">5</span>
                        </div>
                        
                        <button onclick="goToNextPage()" class="nav-btn"
                                style="background: #007cba; border: none; color: white; padding: 10px 15px; border-radius: 50%; cursor: pointer; font-size: 16px; transition: all 0.2s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;"
                                onmouseover="this.style.background='#005a8a'; this.style.transform='scale(1.1)'" 
                                onmouseout="this.style.background='#007cba'; this.style.transform='scale(1)'">
                            ‚ñ∂
                        </button>
                        
                        <!-- Separator -->
                        <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.3);"></div>
                        
                        <!-- Zoom Controls -->
                        <button onclick="zoomOut()" 
                                style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üîç-
                        </button>
                        <button onclick="resetZoom()" 
                                style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            100%
                        </button>
                        <button onclick="zoomIn()" 
                                style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üîç+
                        </button>
                        
                        <!-- Separator -->
                        <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.3);"></div>
                        
                        <!-- Fullscreen -->
                        <button onclick="toggleFullscreen()" 
                                style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ‚õ∂ Fullscreen
                        </button>
                        
                        <!-- Settings -->
                        <button onclick="toggleSettings()" 
                                style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ‚öôÔ∏è
                        </button>
                    </div>
                    
                    <!-- Settings Panel -->
                    <div id="settings-panel" style="position: absolute; bottom: 80px; right: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; min-width: 250px;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">Flipbook Settings</h4>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #666;">View Mode:</label>
                            <select id="view-mode" onchange="changeViewMode(this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="book">Book View (2 pages)</option>
                                <option value="single">Single Page</option>
                                <option value="continuous">Continuous Scroll</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #666;">Page Transition:</label>
                            <select id="transition" onchange="changeTransition(this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="fade">Fade</option>
                                <option value="slide">Slide</option>
                                <option value="flip">Flip Effect</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; color: #666;">
                                <input type="checkbox" id="auto-play" onchange="toggleAutoPlay(this.checked)" style="margin-right: 8px;">
                                Auto-play (5s per page)
                            </label>
                        </div>
                        
                        <button onclick="toggleSettings()" style="width: 100%; padding: 8px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                            Close
                        </button>
                    </div>
                </div>

                <!-- Thumbnail Strip -->
                <div style="margin-top: 30px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Quick Navigation</h4>
                    <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; max-width: 100%; overflow-x: auto; padding: 10px;">
                        <f:for each="{images}" as="image" iteration="iterator">
                            <div class="thumbnail-card" data-page="{image.page}" onclick="goToSpecificPage({image.page})" 
                                 style="flex: 0 0 auto; cursor: pointer; border: 3px solid {f:if(condition: '{iterator.isFirst}', then: '#007cba', else: '#ddd')}; border-radius: 8px; overflow: hidden; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.1)'">
                                <img src="{image.publicUrl}" alt="Page {image.page}" 
                                     style="width: 100px; height: 130px; object-fit: cover; display: block;" />
                                <div style="text-align: center; padding: 8px; background: white; font-size: 12px; font-weight: bold; color: #333;">
                                    Page {image.page}
                                </div>
                            </div>
                        </f:for>
                    </div>
                </div>
                
            </f:then>
            <f:else>
                <div style="text-align: center; padding: 60px; border: 2px dashed #ff6b6b; background: #ffe0e0; border-radius: 8px;">
                    <h3 style="color: #d63031; margin: 0 0 10px 0;">Document Not Found</h3>
                    <p style="margin: 0; color: #666;">The selected document could not be loaded.</p>
                </div>
            </f:else>
        </f:if>
    </div>

    <!-- Enhanced JavaScript with Book Effects -->
    <script>
    console.log('Enhanced Flipbook loaded');
    
    var currentPage = 1;
    var totalPages = 5; // Hardkodovano za sada - mo≈æe se dinamiƒçki setovati
    var viewMode = 'book'; // book, single, continuous
    var transitionType = 'fade'; // fade, slide, flip
    var zoomLevel = 1;
    var autoPlayInterval = null;
    var isFullscreen = false;
    
    // Initialize total pages from DOM when ready
    document.addEventListener('DOMContentLoaded', function() {
        // Count actual pages in DOM
        var pageElements = document.querySelectorAll('.book-page');
        var maxPage = 0;
        for (var i = 0; i < pageElements.length; i++) {
            var pageNum = parseInt(pageElements[i].getAttribute('data-page'));
            if (pageNum > maxPage) maxPage = pageNum;
        }
        if (maxPage > 0) {
            totalPages = maxPage;
            // Update display
            var totalDisplay = document.getElementById('total-pages-display');
            if (totalDisplay) totalDisplay.textContent = totalPages;
        }
        
        showBookPages(currentPage);
        updateDisplay();
        updateThumbnails();
        console.log('Enhanced Flipbook initialized with', totalPages, 'pages');
    });
    
    function goToSpecificPage(page) {
        console.log('Going to specific page:', page);
        
        if (page < 1 || page > totalPages) return;
        if (page === currentPage) return;
        
        var isGoingForward = page > currentPage;
        
        // Add CSS transitions to all pages
        addTransitionsToPages();
        
        // Show page turn effect
        showPageTurnEffect();
        
        // Animate page transition based on type
        if (transitionType === 'slide') {
            animateSlideTransition(page, isGoingForward);
        } else if (transitionType === 'flip') {
            animateFlipTransition(page, isGoingForward);
        } else {
            animateFadeTransition(page);
        }
        
        currentPage = page;
        updateDisplay();
        updateThumbnails();
    }
    
    function addTransitionsToPages() {
        var allPages = document.querySelectorAll('.book-page');
        for (var i = 0; i < allPages.length; i++) {
            allPages[i].style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        }
    }
    
    function animateFadeTransition(targetPage) {
        // First fade out current pages
        var currentPages = document.querySelectorAll('.book-page[style*="block"]');
        for (var i = 0; i < currentPages.length; i++) {
            currentPages[i].style.opacity = '0';
            currentPages[i].style.transform = 'scale(0.95)';
        }
        
        setTimeout(function() {
            hideAllPages();
            if (viewMode === 'book') {
                showBookPages(targetPage);
            } else {
                showSinglePage(targetPage);
            }
            
            // Fade in new pages
            var newPages = document.querySelectorAll('.book-page[style*="block"]');
            for (var i = 0; i < newPages.length; i++) {
                newPages[i].style.opacity = '0';
                newPages[i].style.transform = 'scale(1.05)';
                
                // Force reflow
                newPages[i].offsetHeight;
                
                newPages[i].style.opacity = '1';
                newPages[i].style.transform = 'scale(1)';
            }
        }, 300);
    }
    
    function animateSlideTransition(targetPage, isGoingForward) {
        var direction = isGoingForward ? '100%' : '-100%';
        var oppositeDirection = isGoingForward ? '-100%' : '100%';
        
        // Slide out current pages
        var currentPages = document.querySelectorAll('.book-page[style*="block"]');
        for (var i = 0; i < currentPages.length; i++) {
            currentPages[i].style.transform = 'translateX(' + oppositeDirection + ')';
            currentPages[i].style.opacity = '0.5';
        }
        
        setTimeout(function() {
            hideAllPages();
            if (viewMode === 'book') {
                showBookPages(targetPage);
            } else {
                showSinglePage(targetPage);
            }
            
            // Slide in new pages
            var newPages = document.querySelectorAll('.book-page[style*="block"]');
            for (var i = 0; i < newPages.length; i++) {
                newPages[i].style.transform = 'translateX(' + direction + ')';
                newPages[i].style.opacity = '0.5';
                
                // Force reflow
                newPages[i].offsetHeight;
                
                newPages[i].style.transform = 'translateX(0)';
                newPages[i].style.opacity = '1';
            }
        }, 300);
    }
    
    function animateFlipTransition(targetPage, isGoingForward) {
        var currentPages = document.querySelectorAll('.book-page[style*="block"]');
        
        // Flip out current pages
        for (var i = 0; i < currentPages.length; i++) {
            if (isGoingForward) {
                currentPages[i].style.transform = 'rotateY(-90deg)';
                currentPages[i].style.transformOrigin = 'left center';
            } else {
                currentPages[i].style.transform = 'rotateY(90deg)';
                currentPages[i].style.transformOrigin = 'right center';
            }
            currentPages[i].style.opacity = '0.3';
        }
        
        setTimeout(function() {
            hideAllPages();
            if (viewMode === 'book') {
                showBookPages(targetPage);
            } else {
                showSinglePage(targetPage);
            }
            
            // Flip in new pages
            var newPages = document.querySelectorAll('.book-page[style*="block"]');
            for (var i = 0; i < newPages.length; i++) {
                if (isGoingForward) {
                    newPages[i].style.transform = 'rotateY(90deg)';
                    newPages[i].style.transformOrigin = 'right center';
                } else {
                    newPages[i].style.transform = 'rotateY(-90deg)';
                    newPages[i].style.transformOrigin = 'left center';
                }
                newPages[i].style.opacity = '0.3';
                
                // Force reflow
                newPages[i].offsetHeight;
                
                newPages[i].style.transform = 'rotateY(0deg)';
                newPages[i].style.opacity = '1';
            }
        }, 350);
    }
    
    function goToNextPage() {
        if (currentPage < totalPages) {
            goToSpecificPage(currentPage + 1);
        }
    }
    
    function goToPrevPage() {
        if (currentPage > 1) {
            goToSpecificPage(currentPage - 1);
        }
    }
    
    function hideAllPages() {
        var allPages = document.querySelectorAll('.book-page');
        for (var i = 0; i < allPages.length; i++) {
            allPages[i].style.display = 'none';
            // Reset transforms and opacity
            allPages[i].style.transform = '';
            allPages[i].style.opacity = '1';
        }
    }
    
    function showBookPages(page) {
        // In book view, show current page on right, previous on left (if exists)
        var rightPage = document.querySelector('.right-page[data-page="' + page + '"]');
        if (rightPage) {
            rightPage.style.display = 'block';
            // Initial state for animation
            rightPage.style.opacity = '0';
            rightPage.style.transform = 'scale(0.95)';
        }
        
        if (page > 1) {
            var leftPage = document.querySelector('.left-page[data-page="' + (page - 1) + '"]');
            if (leftPage) {
                leftPage.style.display = 'block';
                // Initial state for animation
                leftPage.style.opacity = '0';
                leftPage.style.transform = 'scale(0.95)';
            }
        }
    }
    
    function showSinglePage(page) {
        var pageEl = document.querySelector('.book-page[data-page="' + page + '"]');
        if (pageEl) {
            pageEl.style.display = 'block';
            // Initial state for animation
            pageEl.style.opacity = '0';
            pageEl.style.transform = 'scale(0.95)';
        }
    }
    
    function showPageTurnEffect() {
        var effect = document.querySelector('.page-turn-effect');
        if (effect) {
            effect.style.opacity = '1';
            effect.style.background = 'linear-gradient(to right, transparent, rgba(255,255,255,0.3), rgba(0,0,0,0.1), transparent)';
            effect.style.transform = 'translateX(-100%)';
            effect.style.transition = 'all 0.6s ease';
            
            // Force reflow
            effect.offsetHeight;
            
            effect.style.transform = 'translateX(100%)';
            
            setTimeout(function() {
                effect.style.opacity = '0';
                effect.style.transform = 'translateX(0)';
            }, 600);
        }
    }
    
    function updateDisplay() {
        var currentDisplay = document.getElementById('current-page-display');
        if (currentDisplay) currentDisplay.textContent = currentPage;
    }
    
    function updateThumbnails() {
        var thumbnails = document.querySelectorAll('.thumbnail-card');
        for (var i = 0; i < thumbnails.length; i++) {
            var thumb = thumbnails[i];
            var thumbPage = parseInt(thumb.getAttribute('data-page'));
            
            // Add smooth transition
            thumb.style.transition = 'all 0.3s ease';
            
            if (thumbPage === currentPage) {
                thumb.style.borderColor = '#007cba';
                thumb.style.borderWidth = '3px';
                thumb.style.transform = 'scale(1.05)';
                thumb.style.boxShadow = '0 4px 15px rgba(0, 124, 186, 0.3)';
            } else {
                thumb.style.borderColor = '#ddd';
                thumb.style.borderWidth = '3px';
                thumb.style.transform = 'scale(1)';
                thumb.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
            }
        }
    }
    
    function zoomIn() {
        zoomLevel = Math.min(zoomLevel + 0.2, 3);
        applyZoom();
    }
    
    function zoomOut() {
        zoomLevel = Math.max(zoomLevel - 0.2, 0.5);
        applyZoom();
    }
    
    function resetZoom() {
        zoomLevel = 1;
        applyZoom();
    }
    
    function applyZoom() {
        var container = document.querySelector('.book-container');
        if (container) {
            container.style.transition = 'transform 0.3s ease';
            container.style.transform = 'scale(' + zoomLevel + ')';
            container.style.transformOrigin = 'center center';
        }
    }
    
    function toggleFullscreen() {
        var container = document.querySelector('.flipbook-container');
        if (!container) return;
        
        if (!document.fullscreenElement) {
            container.requestFullscreen().then(function() {
                isFullscreen = true;
                container.style.position = 'fixed';
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100vw';
                container.style.height = '100vh';
                container.style.zIndex = '9999';
                container.style.background = '#000';
                container.style.padding = '20px';
                container.style.boxSizing = 'border-box';
            }).catch(function(err) {
                console.log('Fullscreen error:', err);
            });
        } else {
            document.exitFullscreen().then(function() {
                isFullscreen = false;
                container.style.position = '';
                container.style.top = '';
                container.style.left = '';
                container.style.width = '';
                container.style.height = '';
                container.style.zIndex = '';
                container.style.background = '';
                container.style.padding = '';
            });
        }
    }
    
    function toggleSettings() {
        var panel = document.getElementById('settings-panel');
        if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    function changeViewMode(mode) {
        viewMode = mode;
        goToSpecificPage(currentPage); // Refresh display
    }
    
    function changeTransition(type) {
        transitionType = type;
    }
    
    function toggleAutoPlay(enabled) {
        if (enabled) {
            autoPlayInterval = setInterval(function() {
                if (currentPage < totalPages) {
                    goToNextPage();
                } else {
                    goToSpecificPage(1); // Loop back to start
                }
            }, 5000);
        } else {
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
            }
        }
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            goToPrevPage();
        }
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            goToNextPage();
        }
        if (e.key === 'Home') {
            e.preventDefault();
            goToSpecificPage(1);
        }
        if (e.key === 'End') {
            e.preventDefault();
            goToSpecificPage(totalPages);
        }
        if (e.key === 'F11') {
            e.preventDefault();
            toggleFullscreen();
        }
        if (e.key === 'Escape' && isFullscreen) {
            toggleFullscreen();
        }
        if (e.key === '+' || e.key === '=') {
            e.preventDefault();
            zoomIn();
        }
        if (e.key === '-') {
            e.preventDefault();
            zoomOut();
        }
        if (e.key === '0') {
            e.preventDefault();
            resetZoom();
        }
    });
    
    // Initialize
    // DOMContentLoaded event is already handled above
    
    // Touch/swipe support for mobile
    var startX = 0;
    var startY = 0;
    
    document.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    });
    
    document.addEventListener('touchend', function(e) {
        var endX = e.changedTouches[0].clientX;
        var endY = e.changedTouches[0].clientY;
        var diffX = startX - endX;
        var diffY = startY - endY;
        
        // Only react to horizontal swipes
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0) {
                // Swiped left - go to next page
                goToNextPage();
            } else {
                // Swiped right - go to previous page
                goToPrevPage();
            }
        }
    });
    
    console.log('Enhanced Flipbook fully loaded');
    </script>

</f:section>

</html>